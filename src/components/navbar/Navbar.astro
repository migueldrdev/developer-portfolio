---
import { Image } from "astro:assets";
import NavbarElement from "@components/navbar/NavbarElement.astro";
import DropDown from "@components/DropDown.astro";
import DarkModeToggle from "@components/DarkModeToggle.astro";
import type { Menu } from "@interfaces/Menu";

// Importar la imagen para optimización
import miguelImage from "/public/miguelDR05.webp";

const { menu = [] } = Astro.props;

// Convertimos el menú a un estado reactivo (opcional si no se usa JS dinámico)
const menuItems = menu.map((item: Menu) => ({
  ...item,
  current: false, // Inicialmente ningún enlace está activo
}));
---

<nav
  class="fixed w-full z-20 top-0 start-0 border-b border-transparent transition-all duration-150"
>
  <div
    id="navbar"
    class="flex flex-wrap items-center justify-end md:justify-center p-4 md:my-2 md:px-4 md:py-1.5 mx-auto md:max-w-xl md:rounded-xl rtl:space-x-reverse"
  >
    <!-- Contenedor de controles (DarkMode + Hamburguesa) -->
    <div class="flex items-center space-x-3 md:space-x-0 md:order-2 rtl:space-x-reverse">
      <DarkModeToggle />

      <!-- Botón hamburguesa: visible solo en móvil (< md) -->
      <button
        data-collapse-toggle="navbar-sticky"
        type="button"
        class="inline-flex items-center p-2 justify-center text-sm rounded-lg md:hidden bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 dark:focus:ring-gray-600 transition-colors"
        aria-controls="navbar-sticky"
        aria-expanded="false"
      >
        <span class="sr-only">Abrir menú principal</span>
        <svg
          class="w-5 h-5"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 17 14"
        >
          <path
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M1 1h15M1 7h15M1 13h15"></path>
        </svg>
      </button>
    </div>

    <!-- Menú de navegación -->
    <div
      class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1"
      id="navbar-sticky"
    >
      <ul
        class="flex flex-col font-medium p-4 md:p-0 mt-4 md:mt-0 bg-gray-50 border border-gray-100 rounded-lg md:bg-transparent md:space-x-8 rtl:space-x-reverse md:flex-row md:border-0 dark:bg-gray-800 md:dark:bg-transparent dark:border-gray-700"
      >
        {
          menuItems.map((item: Menu) => {

            return item.items && item.items.length > 0 ? (
              <li>
                <DropDown label={item.title} items={item.items} />
              </li>
            ) : (
              <NavbarElement {...item} />
            );
          })
        }
      </ul>
    </div>
  </div>
</nav>

<script is:inline>
  // Script para cambiar el navbar al hacer scroll
  function handleNavbarScroll() {
    const navbar = document.getElementById("navbar");

    if (window.scrollY > 20) {
      // Cuando hay scroll: fondo sólido
      navbar.classList.add(
        "bg-white",
        "dark:bg-gray-900",
        "border-gray-200",
        "dark:border-gray-600",
        "shadow-md"
      );
      navbar.classList.remove("border-transparent");
    } else {
      // En la parte superior: transparente
      navbar.classList.remove(
        "bg-white",
        "dark:bg-gray-900",
        "border-gray-200",
        "dark:border-gray-600",
        "shadow-md"
      );
      navbar.classList.add("border-transparent");
    }
  }

  // Ejecutar al cargar la página
  handleNavbarScroll();

  // Ejecutar al hacer scroll (con throttle para mejor performance)
  let ticking = false;
  window.addEventListener("scroll", () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        handleNavbarScroll();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Toggle menú móvil (hamburger)
  const collapseBtn = document.querySelector(
    '[data-collapse-toggle="navbar-sticky"]'
  );
  const collapseTarget = document.getElementById("navbar-sticky");
  if (collapseBtn && collapseTarget) {
    collapseBtn.addEventListener("click", () => {
      const isHidden = collapseTarget.classList.contains("hidden");
      collapseTarget.classList.toggle("hidden", !isHidden);
      const expanded = !isHidden;
      collapseBtn.setAttribute("aria-expanded", expanded.toString());
    });
  }
</script>

<script type="module" src="src/scripts/scroll-spy.js"></script>
